# 応用スパン寸法による調整ロジック

## 概要

従来の300mm倍数（1800, 1500, 1200, 900, 600）のスパンに加えて、より細かい調整が可能な応用スパン寸法（355mm, 150mm）を導入する。これにより、複数の制約（軒の出、境界線など）を同時に満たすことが可能になる。

## 背景と目的

### 従来の問題点

300mm単位でしか調整できないため、以下のような状況で制約を満たせないケースが発生する：

**例：建物北面10000mm**
```
通常計算: 足場総長11700mm（離隔850mm両側）

制約条件:
  - 軒の出800mm → 最小離隔880mm（800 + 80）
  - 西面境界1050mm → 最大離隔990mm（1050 - 60）
  - 東面境界940mm → 最大離隔880mm（940 - 60）

従来の調整（300mm単位）:
  東面: 880mm（境界制約適用）
  西面: 820mm → 軒の出制約違反！

  +300mm調整 → 西面1120mm
  → 境界線990mm制約違反！

  結果: 解なし
```

### 応用スパン寸法による解決

150mmや355mmという細かい調整を加えることで、制約を満たす足場総長さを実現：

```
150mm追加:
  総長11850mm（+150mm）

  東面: 880mm（境界制約）
  西面: 970mm（880 + 調整90mm）

  検証:
    ✓ 軒の出制約: 970 > 880（800 + 80）
    ✓ 境界線制約: 970 < 990（1050 - 60）

  結果: 両制約を満たす！
```

---

## 応用スパン寸法の定義

### 355mm

**使用方法**: 既存スパンとの組み合わせ
```
2155mm = 1800mm + 355mm
```

**使用条件**:
1. **隣接edgeの離隔値が450〜700mmの範囲内**
   - 例: edge2に355mmを使用する場合
     - edge1の離隔値が450〜700mm
     - edge3の離隔値が450〜700mm
     - 両方を満たす必要あり

2. **1方角につき最大2つまで**
   - 北面（または南面）に最大2つ
   - 東面（または西面）に最大2つ

3. **対向面でも同数使用**
   - 北面で355mm × 2使用 → 南面でも355mm × 2使用
   - これにより東西方向の足場総長さが一致

**配置位置**:
- 当面はどこでも可（端部、中央、分散など）

### 150mm

**使用方法**: 既存スパンとの組み合わせ
```
1650mm = 1500mm + 150mm
```

**使用条件**:
1. **特に制約なし**
   - 隣接edgeの離隔値に依存しない

2. **1方角につき1つまで**
   - 北面（または南面）に1つ
   - 東面（または西面）に1つ

3. **対向面でも同数使用**
   - 北面で150mm × 1使用 → 南面でも150mm × 1使用

4. **できる限り使用しない**
   - 最終手段として使用
   - 他の方法で解決できる場合は使用しない

**配置位置**:
- 当面はどこでも可

---

## 検討フロー

### 全体フロー

```
1. 従来計算（300mm倍数のみ）
   ↓
2. 各種制約をチェック
   - 軒の出 + 80mm（最小離隔）
   - 境界線 - 60mm（最大離隔）
   - その他の制約
   ↓
3. 制約を満たしているか？
   YES → 完了
   NO  → 応用スパン寸法の検討へ
   ↓
4. 隣接edgeの離隔値をチェック
   ↓
5. 応用スパン寸法の試行
   （詳細は下記参照）
   ↓
6. 最適な組み合わせを選択
```

### 応用スパン寸法の検討順序

#### ケース1: 隣接edgeの離隔値が450〜700mm範囲内

```
優先順位:
  1. 355mm × 1 を試行
     ↓
  2. 355mm × 2 を試行
     ↓
  3. 150mm × 1 を試行
     ↓
  4. 355mm + 150mm を併用試行
     - 355mm × 1 + 150mm × 1
     - 355mm × 2 + 150mm × 1
     ↓
  5. 300mm増減（従来の調整）
```

**理由**: 隣接edgeの離隔値が制約内の場合、355mmが使用可能なので優先する。

#### ケース2: 隣接edgeの離隔値が450〜700mm範囲外

```
優先順位:
  1. 150mm × 1 を試行
     ↓
  2. 300mm増減（従来の調整）
```

**理由**: 隣接edgeの離隔値が制約外の場合、355mmは使用できないため、150mmのみ検討。

---

## 隣接edgeの定義

### 矩形建物の場合

```
建物平面図:
    edge1（北）
    ┌──────┐
edge4│      │edge2
（西）│      │（東）
    └──────┘
    edge3（南）

隣接関係:
  edge1の隣接edge: edge4, edge2
  edge2の隣接edge: edge1, edge3
  edge3の隣接edge: edge2, edge4
  edge4の隣接edge: edge3, edge1
```

### L字型建物の場合

```
例: 7000 × 10000mm、4000 × 4000mm切り欠き
    edge1
    ┌─────┐
    │     │edge2
edge6│     ├────┐
    │     │ed5 │edge3
    └─────┴────┘
      edge4

隣接関係:
  edge1の隣接edge: edge6, edge2
  edge2の隣接edge: edge1, edge5
  edge3の隣接edge: edge5, edge4
  edge4の隣接edge: edge3, edge6
  edge5の隣接edge: edge2, edge3
  edge6の隣接edge: edge4, edge1
```

**重要**: 異なるedgeの離隔値を参照する。自分自身のedgeではない。

---

## 離隔値の判定タイミング

### 355mmの判定

**タイミング**: 対象edgeに355mmを追加する**前**

**理由**: 隣接edgeは対象edgeとは異なるedgeなので、既に離隔値が確定している。

**例**:
```
L字型建物:
  edge1の離隔値: 850mm（確定済み）
  edge3の離隔値: 900mm（確定済み）

  edge2に355mmを使用できるか判定:
    隣接edge1: 850mm → 範囲外（450〜700mm）
    隣接edge3: 900mm → 範囲外

    → edge2には355mm使用不可
```

```
別のケース:
  edge1の離隔値: 600mm（確定済み）
  edge3の離隔値: 650mm（確定済み）

  edge2に355mmを使用できるか判定:
    隣接edge1: 600mm → 範囲内（450〜700mm）
    隣接edge3: 650mm → 範囲内

    → edge2には355mm使用可能
```

---

## 方角の対応

### 対向面の同数使用ルール

**原則**: 北面で使用したら南面でも同数使用

**理由**: 東西方向（または南北方向）の足場総長さを一致させるため

### 例1: 矩形建物

```
建物: 10000mm × 8000mm（東西 × 南北）

北面で355mm × 2使用:
  足場スパン合計: 10000 + 355 × 2 = 10710mm

南面でも355mm × 2使用:
  足場スパン合計: 10000 + 355 × 2 = 10710mm

→ 東西方向の足場総長さが一致
```

### 例2: 方角別の管理

```
東西方向（北面・南面）:
  北面: 355mm × 2
  南面: 355mm × 2

南北方向（東面・西面）:
  東面: 150mm × 1
  西面: 150mm × 1

→ 方角ごとに独立して管理
```

---

## 足場総長さの計算への影響

### 重要な原則

**応用スパン寸法（355mm, 150mm）は足場総長さの計算に使用する**

これにより、同じ方角の面全体で整合性のある足場総長さが確保される。

### 入隅計算への影響

**原則**:
- 北面で355mm × 2を使用した場合、南面でも355mm × 2を使用
- これにより東西方向の足場総長さが変更される
- この変更された総長さは、入隅計算にも使用される

**例: L字型建物で応用スパンを使用**
```
建物:
  edge1（北）: 7000mm
  edge2（東の一部）: 6000mm

従来計算:
  edge1足場総長: 8700mm（離隔850mm両側）
  edge2足場総長: 7800mm（離隔900mm両側）

北面（edge1）で150mm × 1使用:
  edge1足場総長: 8700 + 150 = 8850mm
  南面（対向する面）でも150mm × 1使用
  → 東西方向の足場総長さが8850mmに変更

入隅計算（edge2など）でこの8850mmを使用:
  edge2の離隔 = 入隅計算ロジック
  edge2の足場総長 = 8850mm（北面の総長を継承）
```

### 下屋（凹型）計算への影響

**原則**:
- 凹型建物（コの字型）でも同様
- 外周面で使用した応用スパンの回数分、同じ方角の全面に適用

**例: コの字型建物で応用スパンを使用**
```
建物:
  10000mm × 10000mm（外枠）
  上辺に4000mm × 2000mmの切り欠き

  edge1（北）: 4800mm（東側）
  edge2（北の窪み）: 2000mm
  edge3（北）: 4800mm（西側）

従来計算:
  東西方向の足場総長: 11700mm

東面で355mm × 1使用:
  東西方向の足場総長: 11700 + 355 = 12055mm

この12055mmを使用して:
  edge1の足場長: (計算式)
  edge2の足場長: (計算式)
  edge3の足場長: (計算式)
  合計: 12055mm
```

### 重要なポイント

1. **足場総長さの一貫性**
   - 同じ方角の全edgeで、応用スパンによる調整を共有
   - 対向面でも同数使用することで、直交する方向の総長さが一致

2. **計算順序**
   - まず外周edgeで応用スパンの必要性を判定
   - 応用スパンを含めた足場総長さを確定
   - その総長さを使って入隅や下屋の計算を実行

3. **整合性の維持**
   - 矩形、L字型、コの字型など、形状に関わらず一貫したルール
   - 足場総長さは常に整合性を持つ

---

## 計算例

### 例1: 軒の出と境界線の複合制約

**条件**:
```
建物北面: 10000mm
軒の出: 800mm
西面境界: 1050mm（建物から）
東面境界: 940mm（建物から）
```

**Step 1: 従来計算**
```
足場総長: 11700mm
離隔: 850mm両側
```

**Step 2: 制約チェック**
```
軒の出制約: 最小離隔 = 800 + 80 = 880mm
東面境界制約: 最大離隔 = 940 - 60 = 880mm
西面境界制約: 最大離隔 = 1050 - 60 = 990mm

東面: 880mm（境界制約適用）
西面: 820mm → 軒の出制約違反（< 880mm）
```

**Step 3: 300mm調整を試行**
```
+300mm → 総長12000mm
新離隔: 1000mm両側

東面: 880mm（境界制約適用）
西面: 1120mm → 境界制約違反（> 990mm）

結果: 不可
```

**Step 4: 隣接edge確認**
```
北面に対する隣接edge: 東面、西面
（矩形なので、東面・西面の離隔値を参照）

東面離隔: 880mm → 範囲外（450〜700mm）
西面離隔: 未確定（調整中）

→ 355mm使用不可、150mmのみ検討
```

**Step 5: 150mm調整を試行**
```
+150mm → 総長11850mm
新離隔: 925mm両側

東面: 880mm（境界制約適用）
調整: 925 - 880 = 45mm
西面: 925 + 45 = 970mm

制約チェック:
  ✓ 軒の出: 970 > 880mm
  ✓ 東面境界: 880 < 880mm
  ✓ 西面境界: 970 < 990mm

結果: 成功！
```

**最終結果**:
```
北面スパン構成: [1800, 1800, 1800, 1800, 1800, 1500, 150]
または: [1800, 1800, 1800, 1800, 1800, 1650]

足場総長: 11850mm
東面離隔: 880mm
西面離隔: 970mm
```

### 例2: 355mmが使用可能なケース

**条件**:
```
L字型建物
edge1離隔: 600mm（確定）
edge2: 計算対象
edge3離隔: 650mm（確定）

何らかの制約で微調整が必要
```

**Step 1: 隣接edge確認**
```
edge2の隣接edge: edge1, edge3

edge1離隔: 600mm → 範囲内（450〜700mm）
edge3離隔: 650mm → 範囲内

→ 355mm使用可能
```

**Step 2: 355mm調整を試行**
```
edge2の足場に355mm追加
例: 従来10000mm → 10355mm

制約を満たすか確認
満たす場合: 採用
```

---

## 実装時の考慮事項

### 1. 全建物形状への対応

応用スパン寸法は以下の全てに対応する：
- 矩形建物
- L字型（入隅）
- 階段形状（連続入隅）
- コの字型（凹型）
- 境界線制約あり

### 2. 試行の効率化

すべてのパターンを試すのではなく、以下の優先順位で試行：
1. 隣接edgeの離隔値チェック
2. 使用可能な応用スパンを特定
3. 優先順位に従って試行
4. 最初に制約を満たしたものを採用

### 3. 複数の解がある場合

優先順位:
1. 355mm（隣接edge制約内の場合）
2. 150mm
3. 355mm + 150mm併用
4. 300mm増減

### 4. エッジケース

- 隣接edgeが存在しない場合の処理
- 複数の応用スパンを使用する際の配置最適化
- 対向面での同数使用の整合性チェック

---

## 次のステップ

1. ✅ ドキュメント作成（本ファイル）
2. ⏳ 応用スパン寸法の計算ロジック実装
3. ⏳ 既存ロジックとの統合
4. ⏳ テストケース作成と検証
5. ⏳ API/MCP対応

---

## 参照

- `basic_allocation_procedure.md`: 基本的な割付計算手順
- `src/logic/spacing.py`: 基本離隔計算
- `src/logic/boundary_constraint.py`: 境界線制約
- `src/logic/dual_boundary_constraint.py`: 両面境界線制約
