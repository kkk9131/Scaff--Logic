# フロントエンド要件定義（足場割付計算システム）

## 1. 要件定義
- 目的: 図面インポート→線抽出→形状自動判定→計算→可視化→図面出力を一連のUIで完結させる。
- データ保管: ブラウザローカル（localStorage/IndexedDB）。サーバー永続化と認証は後日追加。
- 精度: 寸法・計算結果の許容誤差±0.1%（最低±1mm）。
- パフォーマンス目標: 計算応答≤1s、線抽出≤3s（5MB DXF/PDFまたは3000x3000px画像）。
- 対応ブラウザ: 最新Chrome/Edgeを優先（WebXRもここを対象）。Safariは要検証。
- 対応ファイル: DXF R12–R2018、PDFベクタ図、画像は3000x3000px程度まで。拡張子・サイズチェック必須。
- オフライン: インポート〜計算〜出力はネット不要。ライブラリ取得やXRはオンライン前提。

## 2. 必要スクリーン / フロー
1) プロジェクト/履歴一覧（ローカル履歴5–10件、再実行・複製・削除）
2) 図面インポート（DXF/PDF/画像アップロード、拡張子・サイズ・レイヤ選択）
3) 線抽出・クレンジング（レイヤON/OFF、線削除/復元、スナップ、処理ログ）
4) 形状自動判定（矩形/L字/コの字/下屋/突出/階段、信頼度表示、手動修正→再判定）
5) 寸法・パラメータ確認（自動採寸編集、整合性チェック、単位mm、離隔/スパン入力）
6) 計算実行＆結果サマリ（各辺の離隔・足場長、総長カード、エラー表示）
7) 簡易平面図オーバーレイ（離隔帯・スパンを色分け、断面トグル）
8) 立面図ビュー（高さ段差・下屋を縦投影、足場段組）
9) 3Dビュー（Three.js、軌道カメラ、断面スライサー）
10) 図面出力（DXF/PDF/CSV/JSON、レイヤ設定）
11) AR準備（WebXR対応確認、QR生成でモバイル連携。AR描画は将来接続）
12) 設定（デフォルト離隔/スパン、テーマ、APIエンドポイント切替）

## 3. 推奨技術スタック（フロント）
- 3D/可視化: Three.js r178 固定（WebGL2/Float16対応）。
- WebXR/AR: A-Frame 1.7.0 でPoC（将来 Three.js + WebXR に置換可）。
- DXFパース: `dxf` npm 5.3.1（活発メンテ）。代替として `dxf-parser` を検証用に保持。
- PDF: Mozilla `pdf.js` ESM版。
- 画像線検出: `opencv.js` (WASM) with Canny/Hough。
- 幾何処理: `clipper-lib`（オフセット）、`polygon-clipping`（ブーリアン）、`turf`（長さ/面積）。
- DXF出力: `dxf-writer` または `three-dxf`; PDF出力: `pdfkit` / `jspdf`。
- 状態管理: TanStack Query（APIキャッシュ）＋ Zustand または Recoil（UI状態）。
- 2D描画: SVG/Canvasベース。Reactの場合は `react-konva` 併用可。

## 4. データ・運用前提
- 永続化はローカルのみ。履歴件数は5–10件を目安にローテーション。
- アップロード安全策: 拡張子・サイズ検証、パースはWeb Worker内で実行。
- 設定可能項目: 離隔初期値900mm、スパン単位300mm、しきい値(形状判定信頼度0.75)。

## 5. テスト/品質基準
- ゴールデンファイル: 代表DXF/PDF/画像各3種で抽出→判定→計算のE2Eを自動化。
- 精度テスト: 既知寸法ケースで誤差±0.1%以内を検証。
- パフォーマンス計測: 5MB DXF / 3k画像で処理時間を測定し目標内を確認。
- ビジュアル回帰: 平面オーバーレイと3D主要ビューのスクリーンショット差分。
